<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>YOLO ì—…ë¡œë”</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css"/>
    <style>
        body { font-family: sans-serif; margin: 40px; }
        .dropzone {
        border: 3px dashed #007bff;
        border-radius: 10px;
        background: #f0f0f0;
        padding: 30px;
        margin-bottom: 20px;
        }
        button {
        padding: 10px 20px;
        font-size: 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        }
    </style>
    </head>
    <body>
    <h2>ğŸ“¤ YOLO ì´ë¯¸ì§€ + ì–´ë…¸í…Œì´ì…˜ ì—…ë¡œë” (MinIO Presigned)</h2>

    <form action="/" class="dropzone" id="yoloDropzone"></form>

    <button id="uploadBtn">âœ… ì—…ë¡œë“œ ì‹œì‘</button>

    <script>
        Dropzone.autoDiscover = false;
        const bucketName = "yolo-train";  // â† ì‹¤ì œ ë²„í‚·ëª…ì— ë§ê²Œ

        const dz = new Dropzone("#yoloDropzone", {
        autoProcessQueue: false,
        addRemoveLinks: true,
        parallelUploads: 50
        });

        document.getElementById("uploadBtn").addEventListener("click", async () => {
        if (dz.files.length === 0) {
            alert("ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const filenames = dz.files.map(f => f.name);
        try {
            const res = await axios.post(`/upload/presign/?bucket_name=${bucketName}`, filenames);
            const urlMap = Object.fromEntries(res.data.presigned.map(p => [p.file, p.url]));

            for (const file of dz.files) {
            const url = urlMap[file.name];
            if (!url) {
                alert(`${file.name}ì— ëŒ€í•œ presigned URLì´ ì—†ìŠµë‹ˆë‹¤.`);
                continue;
            }
            await axios.put(url, file);
            dz.emit("success", file);
            }

            dz.emit("queuecomplete");
            alert("âœ… ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!");
        } catch (e) {
            console.error(e);
            alert("âŒ presigned URL ìƒì„± ë˜ëŠ” ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
        });
    </script>
</body>
</html>
